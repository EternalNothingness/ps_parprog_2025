# Assignment 3

The goal of this assignment is to get a first grasp of performance-oriented programming. Furthermore, you will be using `perf` for the first time in this lab.

## Exercise 1 (1.5 Points)

### Description

Maybe you have already heard of **Fractals** or **Mandelbrot**. [Fractals](https://en.wikipedia.org/wiki/Fractal) are geometric patterns that appear to be infinitely detailed. There are many [functions](https://en.wikipedia.org/wiki/List_of_fractals_by_Hausdorff_dimension) that can generate such patterns. The more often you evaluate these functions, the more detailed the pattern becomes.

This task will focus on the [Mandelbrot set](https://en.wikipedia.org/wiki/Mandelbrot_set), a set of complex numbers that is generated by the function *z<sub>n+1</sub>=z<sub>n</sub><sup>2</sup>+c*, where *z* is a complex number and *c* is a constant.
> Short reminder: a complex number *z* is the sum of a real part *x* and an imaginary part *y* that includes the imaginary unit *i* with the property (*i<sup>2</sup>=-1*) &rarr; *z=x+yi*.

Since the exact math behind this is not that important to us, we will provide you with pseudocode:

```text
function calc_mandelbrot(image):
    for each (X,Y) do:
        x = 0.0
        y = 0.0
        cx = mapped x_pixel_idx to Mandelbrot x-axis [-2.5, 1]
        cy = mapped y_pixel_idx to Mandelbrot y-axis [-1, 1]
        iteration = 0
        while (x*x + y*y <= 2*2 AND iteration < MAX_ITER) do:
            x_tmp = x*x - y*y + cx
            y = 2*x*y + cy
            x = x_tmp
            iteration = iteration + 1

        norm_iteration = mapped iteration to pixel range [0, 255]
        image[y_pixel][x_pixel] = norm_iteration
```

### Tasks

1) Open the `mandelbrot/mandelbrot.c` file and implement the sequential `calc_mandelbrot` function with the help of the provided pseudocode.
2) Check out the generated image `mandelbrot.png` to see if you implemented the algorithm correctly.
3) Benchmark your program on the LCC3 cluster, document your results and add them to the comparison spreadsheet linked on Discord. How would you improve program performance?
4) Can you think of a way to parallelize this algorithm?

## Exercise 2 (1.5 Points)

### Description

In this exercise, you are asked to investigate the effect of false sharing in multi-threaded programs. Be sure to conduct the measurements on LCC3 through SLURM jobs and not directly on the login node, since you will get different results.

### Tasks

1) Open the two code versions in `false_sharing/` and compare them. What are the differences in the source code and what are the implications?
2) Log into the LCC3 cluster, compile the two programs for a problem size of 100 million. (you can upgrade to a newer GCC using `module load gcc/12.2.0-gcc-8.5.0-p4pe45v`). Compare running the two programs with 6 threads on **6 cores of the same processor** or **6 cores on different processors** (use the information from the previous `hwloc` Assignment and the `lstopo` tool). You can control which cores are used by specifying them in a comma-separated list in the environment variable `GOMP_CPU_AFFINITY`, e.g. `OMP_NUM_THREADS=2 GOMP_CPU_AFFINITY=0,1` would run your program using two threads, one on core 0 and one on core 1. What does the execution time show, and why?
3) Analyze the cache behavior of the two programs using `perf`. `perf` is a tool that can show so-called "performance counter" or "hardware counter" data. It enables you to get hardware count information from the CPU regarding certain events during the execution of your program (clock cycles, cache misses, branch mispredictions, etc.). `perf list` shows a non-exhaustive, short list of events that can be counted on the respective hardware. Compare a general run of `perf stat` to get a high-level overview (i.e. `perf stat <path/to/your/program>`). Can you spot any significant differences in the measurements?
4) Get more detailed information by specifically looking at cache events, e.g. `perf stat -e LLC-load-misses -e LLC-store-misses <path/to/your/program>` or `perf stat -e L1-dcache-load-misses -e L1-dcache-store-misses <path/to/your/program>`. Can you spot any significant differences? Explain the results.
5) Enter the wall clock time of each version on LCC3 to the comparison spreadsheet linked on Discord.
6) Feel free to also check for this effect on your local machines and report the data (including the CPU type!).

## General Notes

All the material required by the tasks above (e.g., code, figures, text, etc...) must be part of the solution that is handed in. Your experiments should be reproducible and comparable to your measurements using the solution materials that you hand in.

**Every** member of your group must be able to explain the given problem, your solution, and possible findings. You may also need to answer detailed questions about any of these aspects.
